# 1. 마스터 노드 생성 (master-init.yaml에 필요한 설정이 모두 포함되어야 함)
multipass launch focal --name k8s-master --memory 2G --disk 10G --cpus 2 --cloud-init master-init.yaml

# 2. 워커 노드 생성 (worker-init.yaml에 필요한 설정이 모두 포함되어야 함)
multipass launch focal --name k8s-worker --memory 2G --disk 10G --cpus 2 --cloud-init worker-init.yaml

# 3. 마스터와 워커 노드 연결
# master 노드의 kubeadm_join_cmd.sh 파일을 호스트의 현재 디렉토리로 가져옴
multipass transfer k8s-master:/home/ubuntu/kubeadm_join_cmd.sh ./

# 호스트에서 worker 노드의 /home/ubuntu 경로로 전송
multipass transfer kubeadm_join_cmd.sh k8s-worker:/home/ubuntu

# 워커에서 실행하여 클러스터에 조인
multipass shell k8s-worker
sudo ./kubeadm_join_cmd.sh

# 4. 클러스터 상태 확인 (마스터 노드에서)
multipass shell k8s-master
kubectl get nodes -o wide
kubectl get pods -A

# 5. 애플리케이션 관련 파일 전송
multipass transfer deployment.yaml k8s-master:/home/ubuntu/deployment.yaml
multipass transfer demo-0.0.1-SNAPSHOT.jar k8s-master:/home/ubuntu/demo-0.0.1-SNAPSHOT.jar
multipass transfer Dockerfile k8s-master:/home/ubuntu/Dockerfile
multipass transfer service.yaml k8s-master:/home/ubuntu/service.yaml
multipass transfer components.yaml k8s-master:/home/ubuntu/components.yaml
multipass transfer hpa.yaml k8s-master:/home/ubuntu/hpa.yaml
multipass transfer hpa_monitor.sh k8s-master:/home/ubuntu/hpa_monitor.sh

# 6. 마스터 노드에서 Docker 권한 설정 후 재접속
sudo usermod -aG docker $USER
exit
multipass shell k8s-master

# 7. 마스터에서 로컬 레지스트리 실행
docker run -d -p 5000:5000 --name registry registry:2

# 8. 애플리케이션 이미지 빌드 및 푸시 (마스터 노드 IP 확인 후 IP 업데이트)
docker build -t localhost:5000/my-spring-app:latest .
docker tag localhost:5000/my-spring-app:latest 192.168.64.27:5000/my-spring-app:latest
docker push 192.168.64.27:5000/my-spring-app:latest

# 9. HTTP 레지스트리 설정 (마스터와 워커 노드 모두)
# 마스터와 워커 노드에서 모두 적용
echo '{"insecure-registries": ["192.168.64.27:5000"]}' | sudo tee /etc/docker/daemon.json
sudo systemctl restart docker

# 10. 클러스터 설정 파일 권한 설정 (필요 시에만)
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 11. Kubernetes 리소스 생성
kubectl delete deployment my-spring-deployment
kubectl apply -f deployment.yaml
kubectl apply -f components.yaml
kubectl apply -f hpa.yaml
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

# 12. 애플리케이션 상태 및 서비스 확인
kubectl get pods -o wide
kubectl describe pod <pod-name>
kubectl apply -f service.yaml
kubectl get services